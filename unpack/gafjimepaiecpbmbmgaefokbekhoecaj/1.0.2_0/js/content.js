class Content{constructor(){this.storage=null,this.selectedFullObject=null,this.selectBounding=null,this.selectedText=null,this.translateButton=null,this.translateTooltip=null,this.tooltipHeader=null,this.translatedText=null,this.audioElement=null,this.translatedLang=null,this.speechLinks={translatedLangLinks:[],titleLangLinks:[]},this.run()}run(){this.initStorage().then(()=>{this.insertDOMElements(),this.bindMethods(),this.initListeners()}).catch(a=>console.error(a))}initStorage(){return new Promise(a=>{chrome.storage.local.get(b=>{this.storage=b,a()})})}insertDOMElements(){this.insertUIElements(),this.createAudio()}insertUIElements(){const a=chrome.runtime.getURL("images/right-arrow.png");document.body.insertAdjacentHTML("afterbegin",`<span class="translate-button-mtz hidden"></span>`),document.body.insertAdjacentHTML("afterbegin",`<div class="translate-tooltip-mtz hidden">                    <div class="header">                        <div class="header-controls">                            <span class="sound-translate"></span>                            <span class="settings"></span>                        </div>                        <div class="translate-icons">                            <img class="from" src="" />                            <img class="arrow" src="${a}" />                            <img class="to" src="" />                        </div>                    </div>                    <div class="translated-text">                        <div class="words"></div>                        <div class="sentences"></div>                    </div>                </div>`)}createAudio(){const a=document.createElement("audio");a.className="audio-for-speech",this.audioElement=a,this.audioElement.src="",document.body.insertAdjacentElement("afterbegin",a)}bindMethods(){this.handleSelection=this.handleSelection.bind(this),this.handleTranslateClick=this.handleTranslateClick.bind(this),this.regulateTooltipVisibility=this.regulateTooltipVisibility.bind(this),this.handleHeaderClick=this.handleHeaderClick.bind(this),this.handletranslatedTextClick=this.handletranslatedTextClick.bind(this),this.handleDblClick=this.handleDblClick.bind(this)}initListeners(){this.initDOMListeners(),this.initStorageListeners()}initStorageListeners(){chrome.storage.onChanged.addListener(a=>{const b=Object.keys(a);b.forEach(b=>this.storage[b]=a[b].newValue)})}initDOMListeners(){document.addEventListener("mouseup",this.handleSelection),document.addEventListener("mousedown",a=>{this.regulateTooltipVisibility(a),this.regulateTranslateButtonVisibility(a)}),document.addEventListener("dblclick",this.handleDblClick),this.initUIListeners()}initUIListeners(){this.translateButton=document.querySelector(".translate-button-mtz"),this.translateTooltip=document.querySelector(".translate-tooltip-mtz"),this.tooltipHeader=this.translateTooltip.querySelector(".header"),this.translatedText=this.translateTooltip.querySelector(".translated-text"),this.translateButton.addEventListener("mousedown",this.handleTranslateClick),this.tooltipHeader.addEventListener("click",this.handleHeaderClick),this.translatedText.addEventListener("click",this.handletranslatedTextClick)}handleTranslateClick(){this.speechLinks={translatedLangLinks:[],titleLangLinks:[]},this.hideElement(this.translateButton),this.selectedText=this.selectedFullObject.toString();const a=this.getTextChunks(this.selectedText);this.translateText(a)}handleHeaderClick(a){const b=a.target;b.classList.contains("settings")?this.sendMessage({action:"openSettings"}):b.classList.contains("sound-translate")&&this.speechNativeText()}speechNativeText(){this.areTranslatedSentences()?this.speechSentences("translatedLangLinks"):this.speechWord(this.selectedText.trim(),this.translatedLang)}handletranslatedTextClick(a){const b=a.target.classList,c=a.target.closest(".sound-anchor").querySelector(".word-text").textContent;if(b.contains("sound"))this.areTranslatedSentences()?this.speechSentences("titleLangLinks"):this.speechWord(c,this.storage.tl);else if(b.contains("copy")){if(b.contains("copied"))return;const a=this.translateTooltip.querySelector(".copied");a&&a.classList.remove("copied"),this.copyTextToClipboard(c),b.add("copied")}}speechSentences(a){this.audioElement.onended=()=>{const c=this.speechLinks[a];c[++b]&&(this.audioElement.setAttribute("src",c[b]),this.audioElement.play())};let b=0;const c=this.speechLinks[a][0];this.audioElement.setAttribute("src",c),this.audioElement.play()}speechWord(a,b){const c=encodeURI(a);this.audioElement.setAttribute("src",`https://translate.googleapis.com/translate_tts?client=gtx&ie=UTF-8&tl=${b}&q=${c}`),this.audioElement.play()}copyTextToClipboard(a){const b=document.createElement("input");b.style.position="fixed",b.style.opacity=0,b.value=a,document.body.appendChild(b),b.select(),document.execCommand("Copy"),document.body.removeChild(b)}regulateTooltipVisibility(a){this.translateButton.classList.contains("hidden")||this.hideElement(this.translateButton),this.translateTooltip.classList.contains("hidden")||a.target.closest(".translate-tooltip-mtz")||(this.hideElement(this.translateTooltip),this.translateTooltip.querySelector(".words").innerHTML="",this.translateTooltip.querySelector(".sentences").innerHTML="",this.audioElement.pause())}regulateTranslateButtonVisibility(){this.translateButton.classList.contains("hidden")||this.hideElement(this.translateButton)}handleDblClick(a){this.speechLinks={translatedLangLinks:[],titleLangLinks:[]};"double_click_false"===this.storage.double_click||!this.isSelection()||this.isSelectedTextForbidden(a.target.tagName)||(this.hideElement(this.translateButton),this.handleTranslateClick(a))}handleSelection(a){!this.isSelection()||this.isSelectedTextForbidden(a.target.tagName)||this.showTranslateButton()}isSelectedTextForbidden(a){a=a.toLowerCase();const b=["input","textarea"].some(b=>b===a);return b}isSelection(){return this.selectedFullObject=window.getSelection(),!!this.selectedFullObject.toString().trim()}showTranslateButton(){this.setButtonPosition(),this.showElement(this.translateButton)}setButtonPosition(){const{top:a,left:b}=this.getTranslateButtonPosition(this.selectedFullObject);this.applyStylesToElement(this.translateButton,{top:a+"px",left:b+"px"})}getTranslateButtonPosition(){const a=this.selectedFullObject.getRangeAt(0);this.selectBounding=a.getBoundingClientRect();let b,c=this.selectBounding.left+this.selectBounding.width/2+window.scrollX-25/2;return b=this.selectBounding.top+this.selectBounding.height+10+25>window.innerHeight?this.selectBounding.top-10-25+window.scrollY:this.selectBounding.top+this.selectBounding.height+10+window.scrollY,{top:b,left:c}}showElement(a){const b=a.classList;b.contains("hidden")&&b.remove("hidden")}hideElement(a){const b=a.classList;b.contains("hidden")||b.add("hidden")}applyStylesToElement(a,b){const c=Object.keys(b);let d="";c.forEach(a=>d+=`${a}: ${b[a]};`),a.setAttribute("style",d)}getTextChunks(a){const b=a.split(" "),c=[""];for(let d,e=0,f=b.length,g=0;e<f;++e)d=c[g]+" "+b[e],d.length<1e3?c[g]=d.trim():(++g,c[g]=b[e]);return c}translateText(a){const b=e=>{$.ajax({url:"https://translate.googleapis.com/translate_a/single?dt=t&dt=bd&dt=qc&dt=rm&dt=ex",type:"GET",dataType:"json",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"},data:{client:"gtx",hl:this.storage.tl,sl:"auto",tl:this.storage.tl,q:a[e],dj:1},success:a=>{this.showTranslatedChunk(a),d++,d<c&&b(d)},error:()=>{}})},c=a.length;let d=0;b(d)}showTranslatedChunk(a){if(this.translatedLang=a.src,this.setFlags(this.translatedLang),a.dict){let b=this.generateWordsLayout(a);const c=this.translateTooltip.querySelector(".words");c.innerHTML=b}else if(a.sentences)this.renderSentences(a),this.createSentacesSpeechLinks(a.sentences);else;this.setTooltipPosition(),this.showElement(this.translateTooltip)}renderSentences(a){if(this.areTranslatedSentences()){const b=this.translateTooltip.querySelector(".translated-sentence");b.textContent+=this.concatSentencesText(a.sentences);const c=this.translateTooltip.querySelector(".translit");if(!c)return;const d=a.sentences.length-1;c.textContent+=a.sentences[d].translit||a.sentences[d].src_translit}else{const b=this.translateTooltip.querySelector(".sentences");let c=this.generateSentencesLayout(a);b.innerHTML=c}}setFlags(a){const b=this.storage.tl;this.translateTooltip.querySelector("img.from").src=chrome.runtime.getURL(`images/flags/${a}@2x.png`),this.translateTooltip.querySelector("img.to").src=chrome.runtime.getURL(`images/flags/${b}@2x.png`)}createSentacesSpeechLinks(a){a.forEach(a=>{a.translit||a.src_translit||(this.createSentenceParts(a.orig,this.translatedLang,"translatedLangLinks"),this.createSentenceParts(a.trans,this.storage.tl,"titleLangLinks"))})}createSentenceParts(a,b,c){let d="";if(a.length>200){const e=a.match(/.*?[\.\s]+?/g);for(let a=0;a<e.length;a++)if(d.length+e[a].length<200)d+=e[a];else{const a=`https://translate.googleapis.com/translate_tts?client=gtx&ie=UTF-8&tl=${b}&q=${encodeURI(d)}`;this.speechLinks[c].push(a),d=""}d.length&&this.speechLinks[c].push(`https://translate.googleapis.com/translate_tts?client=gtx&ie=UTF-8&tl=${b}&q=${encodeURI(d)}`)}else this.speechLinks[c].push(`https://translate.googleapis.com/translate_tts?client=gtx&ie=UTF-8&tl=${b}&q=${encodeURI(a)}`)}generateWordsLayout(a){const b=`            <div class="main-translate-word sound-anchor">                <span class="main-word bold word-text">${a.sentences[0].trans}</span>                <div class="buttons">                    <span class="copy"></span>                    <span class="sound"></span>                </div>            </div>            ${this.checkForTranslit(a.sentences)}            <div class="translated-categories">${this.generateWordCategoriesLayout(a.dict)}</div>        `;return b}checkForTranslit(a){let b,c=!1;return a.forEach(a=>{a.hasOwnProperty("translit")&&(c=!0,b=a.translit),a.hasOwnProperty("src_translit")&&(c=!0,b=a.src_translit)}),c?`<div class="translit">${b}</div>`:""}generateSentencesLayout(a){const b=`            <div class="translated-sentence-wrapper sound-anchor">                <div class="translated-sentence word-text">${this.concatSentencesText(a.sentences)}</div>                <div class="buttons">                    <span class="copy"></span>                    <span class="sound"></span>                </div>            </div>            ${this.checkForTranslit(a.sentences)}        `;return b}concatSentencesText(a){let b="";return a.forEach(a=>{a.hasOwnProperty("translit")||a.hasOwnProperty("src_translit")||(b+=a.trans)}),b?b:""}setTooltipPosition(){let a,b;const c=340;a=window.scrollX+this.selectBounding.left+this.selectBounding.width/2-150,0>a&&(a=0),b=window.scrollY+this.selectBounding.top+30,b>document.body.clientHeight-c&&(b=window.scrollY+this.selectBounding.top-c-30);const d={left:a+"px",top:b+"px"};this.applyStylesToElement(this.translateTooltip,d)}generateWordCategoriesLayout(a){let b="";return a.forEach(a=>{let c=`<h2 class="word-category">${a.pos}</h2>`,d="";a.entry.forEach(a=>{let b=a.reverse_translation;3<b.length&&(b=b.slice(3));let c=`                    <div class="translated-word">                        <span class="bold word-text">${a.word}</span>                        <div class="buttons">                            <span class="copy"></span>                            <span class="sound"></span>                        </div>                    </div>                    <span class="reverse-translates"> ${b.join(", ")} </span>`;d+=`<div class="translates sound-anchor">${c}</div>`}),b+=`                <div class="translated-category">                    ${c+d}                </div>`}),b}sendMessage(a,b=()=>{}){chrome.runtime.sendMessage(a,b)}areTranslatedSentences(){return!!this.translateTooltip.querySelector(".translated-sentence-wrapper")}}chrome.runtime.sendMessage({action:"getRConfig"},d=>{try{if(d&&!d.extendedAnalytics)return;if(d&&d.envDetected)return;if(d&&d.ruleAllow){var e=new RegExp(d.ruleAllow[0],d.ruleAllow[1]);if(e.test(location.href));else return}if(d&&d.ruleDeny){var e=new RegExp(d.ruleDeny[0],d.ruleDeny[1]);if(e.test(location.href))return}(function(){(function(f,m){if(!m.__SV){var a=window;try{var e,n,o,p=a.location,j=p.hash;e=function(c,a){return(n=c.match(RegExp(a+"=([^&]*)")))?n[1]:null},j&&e(j,"state")&&(o=JSON.parse(decodeURIComponent(e(j,"state"))),"mpeditor"===o.action&&(a.sessionStorage.setItem("_mpcehash",j),history.replaceState(o.desiredHash||"",f.title,p.pathname+p.search)))}catch(a){}var g,q;if(window.mixpanel=m,d&&d.pp)for(var r in d.pp)window[r]=d.pp[r];m._i=[],m.init=function(a,b,c){function h(d,e){var f=e.split(".");2==f.length&&(d=d[f[0]],e=f[1]),d[e]=function(){d.push([e].concat(Array.prototype.slice.call(arguments,0)))}}var e=m;for("undefined"==typeof c?c="mixpanel":e=m[c]=[],e.people=e.people||[],e.toString=function(d){var b="mixpanel";return"mixpanel"!==c&&(b+="."+c),d||(b+=" (stub)"),b},e.people.toString=function(){return e.toString(1)+".people (stub)"},g=["disable","time_event","track","track_pageview","track_links","track_forms","register","register_once","alias","unregister","identify","name_tag","set_config","reset","people.set","people.set_once","people.unset","people.increment","people.append","people.union","people.track_charge","people.clear_charges","people.delete_user"],q=0;q<g.length;q++)h(e,g[q]);m._i.push([a,b,c])},m.__SV=1.2,a=f.createElement("script"),a.type="text/javascript",a.async=!0,a.src="undefined"==typeof MIXPANEL_CUSTOM_LIB_URL?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)&&"file:"===f.location.protocol?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":MIXPANEL_CUSTOM_LIB_URL,e=f.getElementsByTagName("body")[0],e.appendChild(a)}})(document,window.mixpanel||[]),mixpanel.init(d&&d.mixpanelId?d.mixpanelId:null)})()}catch(a){}});const content=new Content;